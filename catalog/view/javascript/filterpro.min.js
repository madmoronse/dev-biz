var fIID = 0;
var interval = 1;
var $cookie = false;
var container = ".product-{view}";
/**
 * fixs for IE
 */
if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function(obj, start) {
        for (var i = (start || 0), j = this.length; i < j; i++) {
            if (this[i] === obj) {
                return i;
            }
        }
        return -1;
    }
}

function escapeHtml(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
}

String.prototype.hashCode = function() {
    var hash = 0,
        i, ch;
    if (this.length == 0) return hash;
    for (i = 0; i < this.length; i++) {
        ch = this.charCodeAt(i);
        hash = ((hash << 5) - hash) + ch;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash;
};

var tag_tmpl = $.template(null, '<input id="tag_${tag}" class="filtered" type="checkbox" name="tags[]" value="${tag}" {{if checked}} checked="checked" {{/if}}>' +
    '<label for="tag_${tag}">${name}</label>');
var cat_tmpl = $.template(null, '<input id="cat_${category_id}" class="filtered" type="checkbox" name="categories[]" value="${category_id}" {{if checked}} checked="checked" {{/if}}>' +
    '<div class="categories"><label for="cat_${category_id}">${name}</label></div>');
$(".price_limit").live("change", (function() {
    var b = parseInt($("#min_price").val());
    var a = parseInt($("#max_price").val());
    $("#slider-range").slider("values", [b, a]);
    iF()
}));

function synchronizeImgCheckboxes() {
    $("#filterpro input.filtered[type=\"checkbox\"]").each(function() {
        var $img = $(this).next('img');
        if ($img.length) {
            if ($(this).is(":checked")) {
                $img.addClass("selected");
            } else {
                $img.removeClass("selected");
            }
        }
    });
}
// $("#filterpro .filtered").live("change", (function () {
//     iF();
// }));

$(".filter_apply").live("click", (function() {
    $(this).parents(".collapsible").slideUp(500);
    iF();
}));

$(function() {
    $("#slider-range").slider({
        range: true,
        min: 0,
        max: 0,
        values: [0, 0],
        stop: function(a, b) {
            iF()
        },
        slide: function(a, b) {
            $("#min_price").val(b.values[0]);
            $("#max_price").val(b.values[1])
        }
    });
    $("#min_price").val($("#slider-range").slider("values", 0));
    $("#max_price").val($("#slider-range").slider("values", 1))
});

function iF() {
    clearTimeout(fIID);
    $("#filterpro_page").val(0);
    fIID = setTimeout("doFilter(false)", interval)
}

function success(g, b) {

    if ($cookie) {
        var view = $cookie("display");
    }
    if (!view) {
        view = "list";
    }
    var cont = container.replace('{view}', view);

    var hash = window.location.hash.substr(1);
    //On first enter to page ajax won't update content, so we comment out the (&& hash),
    //because content we get from backend differs from logic of filters
    //При первом заходе на страницу контент не обновлялся, но так как логика выборок 
    //из фильтра и model_product разная, то мы отключаем эту фишку
    if (g.result_html /*&& hash*/) {
        $(cont).html(g.result_html);
        afterload();
    }
    $(".pagination").html(g.pagination);
    if (b && g.min_price == g.max_price) {
        $('.price_slider').hide();
    }
    var d = parseInt(g.min_price);
    var c = Math.ceil(parseFloat(g.max_price));

    if (typeof(display) != "undefined") {
        view ? display(view) : display("list");
    }
    if (b) {
        $("#slider-range").slider("option", { min: d, max: c });
        if ($("#max_price").val() >= 1) {
            d = parseInt($("#min_price").val());
            c = parseInt($("#max_price").val())
        }
        $("#slider-range").slider("option", { values: [d, c] });
        $("#min_price").val(d);
        $("#max_price").val(c)
    }
    if (g.totals_data) {
        if (g.totals_data.tags.length) {
            $('#filter_tags').html('');
            $.tmpl(tag_tmpl, g.totals_data.tags).appendTo('#filter_tags');
            $('#filter_tags').parents('.option_box').show();
        } else {
            $('#filter_tags').parents('.option_box').hide();
        }

        $('#filter_categories').html('');
        if (g.totals_data.categories.length) {
            $.tmpl(cat_tmpl, g.totals_data.categories).appendTo('#filter_categories');
            $('#filter_categories').parents('.option_box').show();
        } else {
            $('#filter_categories').parents('.option_box').hide();
        }

        var atts = {};
        $.each(g.totals_data.attributes, function(k, v) {
            atts[(v.id + "_" + v.text).replace(/\s/g, '_')] = v.t;
        });

        $('.a_name').each(function(k, v) {
            var at_v_i = $(v).attr('at_v_i').replace(/\s/g, '_');
            var at_v_i_e = escapeHtml(at_v_i);
            if (atts[at_v_i]) {
                $('[at_v_t="' + at_v_i_e + '"]').text($('[at_v_t="' + at_v_i_e + '"]').attr('data-value') + " (" + atts[at_v_i] + ")");
                $(v).removeAttr("disabled");
            } else {
                $('[at_v_t="' + at_v_i_e + '"]').text($('[at_v_t="' + at_v_i_e + '"]').attr('data-value'));
                $(v).attr("disabled", "disabled");
                $(v).removeAttr('checked');
                $(v).removeAttr(':selected');
            }
        });

        var h = [];
        $.each(g.totals_data.manufacturers, function(f, k) {
            if (k.id) {
                h[h.length] = k.id;
                var j = $("#manufacturer_" + k.id);
                j.removeAttr("disabled");
                if (j.get(0) && j.get(0).tagName == "OPTION") {
                    j.text($("#m_" + k.id).val() + " (" + k.t + ")")
                } else {
                    $('label[for="manufacturer_' + k.id + '"]').text($("#m_" + k.id).val() + " (" + k.t + ")")
                }
            }
        });
        $(".manufacturer_value").each(function(f, k) {
            var j = $(this);
            var l = j.attr("id").match(/manufacturer_(\d+)/);
            if ($.inArray(l[1], h) < 0) {
                j.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    j.text($("#m_" + l[1]).val());
                    j.prop("selected", false)
                } else {
                    $('label[for="manufacturer_' + l[1] + '"]').text($("#m_" + l[1]).val());
                    j.prop("checked", false)
                }
            }
        });
        var e = [];
        $.each(g.totals_data.options, function(j, k) {
            if (k.id) {
                e[e.length] = k.id;
                var f = $("#option_value_" + k.id);
                if (f.length) {
                    f.removeAttr("disabled");
                    if (f.get(0).tagName == "OPTION") {
                        /* f.text($("#o_" + k.id).val() + " (" + k.t + ")")
                    } else {
                        $('label[for="option_value_' + k.id + '"]').text($("#o_" + k.id).val() + " (" + k.t + ")")*/
                    }
                }
            }
        });
        $(".option_value").each(function(j, k) {
            var f = $(this);
            var l = f.attr("id").match(/option_value_(\d+)/);
            if ($.inArray(l[1], e) < 0) {
                f.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    f.text($("#o_" + l[1]).val());
                    f.attr("selected", false)
                } else {
                    $('label[for="option_value_' + l[1] + '"]').text($("#o_" + l[1]).val());
                    f.attr("checked", false)
                }
            }
        })
    }
}
var cache = [];

function doFilter(b) {
    addProgressBar();
    var a = $("#filterpro").serialize().replace(/[^&]+=\.?(?:&|$)/g, "").replace(/&+$/, "");
    if (!b) {
        window.location.hash = a
    }
    var h = a.hashCode();
    if (window.location.search.indexOf('novently=1') != -1) h += 'novently';
    if (window.location.search.indexOf('withdiscount=1') != -1) h += 'withdiscount';
    if (cache[h]) {
        success(cache[h]);
        createTags4filter();
        clearActiveBoxes();
        setTimeout(function() {
            removeProgressBar();
        }, 500);
    } else {
        if ($cookie) {
            var view = $cookie("display");
        }
        if (!view) {
            view = "list";
        }
        var cont = container.replace('{view}', view);

        /* $(cont).mask();
         $(".filterpro").mask();*/
        addProgressBar();

        var url = 'index.php?route=module/filterpro/getproducts';
        window.location.search.indexOf('novently=1') != -1 ? url += '&novently=1' : {};
        window.location.search.indexOf('withdiscount=1') != -1 ? url += '&withdiscount=1' : {};
        $.ajax({
            url: url,
            type: "POST",
            data: a + (b ? "&getPriceLimits=true" : ""),
            dataType: "json",
            error: function(xhr, error) {
                removeProgressBar();
            },
            success: function(g) {
                success(g, b);
                removeProgressBar();
                createTags4filter();
                clearActiveBoxes();
                cache[h] = g;
                $(cont).unmask();
                $(".filterpro").unmask();
            }
        });
    }
}

function clearActiveBoxes() {
    $('#filterpro .option_box.active').each(function() {
        if (!$(this).find('[type="checkbox"]:checked').length && !$(this).find('[type="radio"]:checked').length) {
            $(this).removeClass('active');
        }
    })
}

function createTags4filter() {
    var chosen = '';
    var checked = $('#filterpro [type="checkbox"]:checked');
    if (checked.length) {
        $('.filterpro-chosen').addClass('filterpro-chosen--active');
        checked.each(function() {
            var id = $(this).attr('id');
            chosen += [
                '<div class="filterpro-chosen__item">',
                '<span>',
                ($('[for="' + id + '"]').hasClass('size') ? 'Размер ' : '') + $('[for="' + id + '"]').html().replace(/\([0-9]*\)/, ""),
                '</span>',
                '<a href="#' + id + '" class="filterpro-chosen__remove"></a>',
                '</div>',
            ].join('');
            $('.filterpro-chosen__wrapper').html(chosen);
            $('.filterpro-chosen__remove').on('click', function(e) {
                e.preventDefault();
                addProgressBar();
                var id = $(this).attr('href');
                $(id).prop('checked', false);
                doFilter();
            });
        });
    } else {
        $('.filterpro-chosen').removeClass('filterpro-chosen--active');
        $('.filterpro-chosen__wrapper').html(chosen);
    }
}

function addProgressBar() {
    $('#content').addClass('content-is-loading');
}

function removeProgressBar() {
    $('#content').removeClass('content-is-loading');
}

$(document).ready(function() {
    container = $('#filterpro_container').val();
    if ($.totalStorage != undefined) {
        $cookie = $.totalStorage;
    } else if ($.cookie != undefined) {
        $cookie = $.cookie;
    }

    /* $(".option_box .option_name").mouseover(function () {
         $(this).siblings(".collapsible").show('fast');
         $(this).removeClass("hided")
     });
     $(".option_box .attribute_group_name").mouseover(function () {
         $(this).siblings(".attribute_box").show('fast');
         $(this).removeClass("hided")
     });

     $(".option_box").mouseleave(function () {
         $(this).children(".collapsible").hide();
         $(this).children(".option_name").addClass("hided")
     });
     $(".option_box").mouseleave(function () {
         $(this).children(".attribute_box").hide();
         $(this).children(".option_name").addClass("hided")
     });*/
    $(document).mouseup(function(e) { // событие клика по веб-документу
        var div = $(".option_box"); // тут указываем ID элемента
        if (!div.is(e.target) // если клик был не по нашему блоку
            &&
            div.has(e.target).length === 0) { // и не по его дочерним элементам
            div.siblings(".collapsible").slideUp(500); // скрываем его
        }
    });
    $(".option_box .option_name").click(function() {
        $(this).siblings(".collapsible").slideToggle(500);
        $(".option_box .option_name").not(this).siblings(".collapsible").slideUp(500);
        //$(this).toggleClass("hided")
    });
    //Add click for radiobox discount
    $('.option_box.filterpro-discount label').click(function () {
        $(this).parents('.filterpro__section').find('.option_box.active').removeClass('active').find('input').prop('checked', false);
        $(this).parent().addClass('active');
        iF();
    });
    $(".option_box .attribute_group_name").click(function() {
        $(this).siblings(".attribute_box").slideToggle(500);
        $(".option_box .attribute_group_name").not(this).siblings(".collapsible").slideUp(500);
    });

    $(".clear_filter").click(function() {
        $("#filterpro img").removeClass("selected");
        $("#filterpro select").val("");
        $("#filterpro :input").each(function() {
            if ($(this).is(":checked")) {
                $(this).attr("checked", false)
            }
        });
        var b = $("#slider-range").slider("option", "min");
        var a = $("#slider-range").slider("option", "max");
        $("#slider-range").slider("option", { values: [b, a] });
        $("#min_price").val(b);
        $("#max_price").val(a);
        $("div[id^=slider-range-]").each(function(index, element) {
            var id = this.id.replace(/[^\d]/g, '');

            var b = $(element).slider("option", "min");
            var a = $(element).slider("option", "max");

            hs = $(element).slider();
            hs.slider("option", { values: [b, a] });
            hs.slider("option", "slide").call(hs, null, { handle: $(".ui-slider-handle", hs), values: [b, a] });

            $("#attribute_value_" + id + "_min").val('');
            $("#attribute_value_" + id + "_max").val('');

        });
        //Discounts
        if ($("#discount_all").length) {
            $("#discount_all").parent().addClass('active');
            $("#discount_all").prop('checked', true);
        }
        iF()
    });
    $(".pagination .links a").live("click", (function() {
        var a = $(this).attr("href");
        var b = a.match(/page=(\d+)/);
        var page;
        if (!b) page = 1;
        else page = b[1];
        $("#filterpro_page").val(page);
        doFilter(false);
        //$('html, body').animate({ scrollTop: $('#container').offset().top }, 'slow');
        $('html, body').animate({ scrollTop: $('#content').offset().top - 30 });
        return false;
    }));

    if ($(".sort select").length) {
        $(".sort select").get(0).onchange = null;
        $(".sort select").change(function() {
            var d = $(this).val();
            var a = gUV(d, "sort");
            var b = gUV(d, "order");
            $("#filterpro_sort").val(a);
            $("#filterpro_order").val(b);
            iF()
        });
    }

    if ($(".limit select").length) {
        $(".limit select").get(0).onchange = null;
        $(".limit select").change(function() {
            $("#filterpro_limit").val(gUV($(this).val(), "limit"));
            iF()
        });
    }

    // deserialize
    var hash = window.location.hash.substr(1);
    if (hash && $('instock').is(':visible') && $('instock').is(':checked')) {
        $('instock').attr("checked", false);
    }
    $("#filterpro").deserialize(hash);
    //Make Discount Active After Load
    $("#filterpro").find('[name="discount"]:checked').parent().addClass('active');
    if (!$("#filterpro").find('[name="discount"]:checked').length) {
        $("#discount_all").parent().addClass('active');
        $("#discount_all").prop('checked', true);
    }
    synchronizeImgCheckboxes();

    $("#filterpro img").bind("click", function() {
        var $input = $(this).prev("input");
        if ($input.attr("disabled")) {
            return;
        }
        $(this).toggleClass("selected");
        $input.prop('checked', !$input.prop('checked'));
        iF();
    });


    $("div[id^=slider-range-]").each(function(index, element) {
        var id = this.id.replace(/[^\d]/g, '');
        var arr = window['attr_arr_' + id];

        var b = parseInt($("#attribute_value_" + id + "_min").val());
        var a = parseInt($("#attribute_value_" + id + "_max").val());
        b = arr.indexOf(b);
        a = arr.indexOf(a);
        if (a >= 0 && b >= 0) {
            hs = $(element).slider();
            hs.slider("option", { values: [b, a] });
            hs.slider("option", "slide").call(hs, null, { handle: $(".ui-slider-handle", hs), values: [b, a] });
        }
    });

    if ($(".sort select").length) {
        if ($("#filterpro_sort").val()) {
            $(".sort select").each(function(i, e) {
                if (gUV($(this).val(), "sort") == $("#filterpro_sort").val() && gUV($(this).val(), "order") == $("#filterpro_order").val()) {
                    $(".sort select").val($(this).val());
                    return;
                }
            });
        } else {
            $val = $(".sort select").val();
            $("#filterpro_sort").val(gUV($val, "sort"));
            $("#filterpro_order").val(gUV($val, "order"))
        }
    }
    if ($("#filterpro_limit").length) {
        if ($("#filterpro_limit").val()) {
            $(".limit select").val($("#filterpro_limit").val());
        } else {
            $("#filterpro_limit").val(gUV($(".limit select").val(), "limit"));
        }
    }
    doFilter(true)
});

function gUV(e, f) { var c = String(e).split("?"); var a = ""; if (c[1]) { var b = c[1].split("&"); for (var g = 0; g <= (b.length); g++) { if (b[g]) { var d = b[g].split("="); if (d[0] && d[0] == f) { a = d[1] } } } } return a }