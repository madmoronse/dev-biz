<!-- Created using vQmod XML Generator by UKSB - http://uksb.github.com/vqgen/ //-->
<modification>
	<id><![CDATA[pav_blog_seo_pro]]></id>
	<version><![CDATA[1.0]]></version>
	<vqmver><![CDATA[2.4.1]]></vqmver>
	<author><![CDATA[Tom(opencartforum)]]></author>
	<file name="catalog/controller/common/seo_pro.php">
		<operation>
			<search position="before"><![CDATA[if (isset($queries[$parts[0]])) {]]></search>
			<add><![CDATA[//PAV BLOGS SEO PRO
 if( isset($url) && count($url) == 2 && ( preg_match( "#pavblog#", $url[0] )) ){
 unset($this->request->get['pavblog/category']);
 unset($this->request->get['pavblog/blog']);
 unset($queries);
 $this->request->get['route'] = $url[0];
 $this->request->get['id'] = $url[1];
 } 
//PAV BLOGS SEO PRO]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[case 'product/product/review':]]></search>
			<add><![CDATA[//PAV BLOGS SEO PRO
case 'pavblog/category':
break;
case 'pavblog/blog':
$isblog = 1;
break;
// PAV BLOGS SEO PRO END]]></add>
		</operation>
		<operation>
			<search position="after" offset="3"><![CDATA[$queries[] = 'category_id=' . $category;]]></search>
			<add><![CDATA[//PAV BLOGS SEO PRO
case 'id':
if(isset($isblog)){
if ($this->config->get('config_seo_url_include_path')) {
$blogpath = $this->getPathByBlog($value);
if($blogpath){
$categories = explode('_', $blogpath);
foreach ($categories as $category) {
$queries[] = 'pavblog/category=' . $category;
}
}
}
$queries[] = 'pavblog/blog=' . $value;
$postfix = 1;
}else{
$category = $value;
$blogpath = $this->getPathByBlogCat($category);
if($blogpath){
$categories = explode('_', $blogpath);
foreach ($categories as $category) {
$queries[] = 'pavblog/category=' . $category;
}
}
}
unset($data[$key]);
break;
// PAV BLOGS SEO PRO END]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[private function getPathByProduct($product_id) {]]></search>
			<add><![CDATA[// PAV BLOGS SEO PRO 
private function getPathByBlog($blog_id) {
$blog_id = (int)$blog_id;
if ($blog_id < 1) return false;
 
static $path = null;
if (!is_array($path)) {
$path = $this->cache->get('blog.seopath');
if (!is_array($path)) $path = array();
}
 
if (!isset($path[$blog_id])) {
$query = $this->db->query("SELECT category_id FROM " . DB_PREFIX . "pavblog_blog WHERE blog_id = '" . $blog_id . "' ORDER BY category_id DESC LIMIT 1");
 
$path[$blog_id] = $this->getPathByBlogCat($query->num_rows ? (int)$query->row['category_id'] : 0);
 
$this->cache->set('blog.seopath', $path);
}
 
return $path[$blog_id];
}
 
private function getPathByBlogCat($category_id) {
$category_id = (int)$category_id;
if ($category_id < 1) return false;
 
static $path = null;
if (!is_array($path)) {
$path = $this->cache->get('blogcat.seopath');
if (!is_array($path)) $path = array();
}
 
if (!isset($path[$category_id])) {
$max_level = 2;
 
$sql = "SELECT CONCAT_WS('_'";
for ($i = $max_level-1; $i >= 0; --$i) {
$sql .= ",t$i.category_id";
}
$sql .= ") AS path FROM " . DB_PREFIX . "pavblog_category t0";
for ($i = 1; $i < $max_level; ++$i) {
$sql .= " LEFT JOIN " . DB_PREFIX . "pavblog_category t$i ON (t$i.category_id = t" . ($i-1) . ".parent_id)";
}
$sql .= " WHERE t0.category_id = '" . $category_id . "'";
 
$query = $this->db->query($sql);
 
$path[$category_id] = $query->num_rows ? $query->row['path'] : false;
 
$this->cache->set('blogcat.seopath', $path);
}
 
return $path[$category_id];
}
// PAV BLOGS SEO PRO END]]></add>
		</operation>
	</file>
</modification>