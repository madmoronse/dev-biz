<?xml version="1.0" encoding="UTF-8"?>
<modification>

  <id>Live Search (with images)</id>
  <version>1.1.0</version>
  <vqmver>2.4.0</vqmver>
  <author>Kardos SÃ¡ndor / sandor.kardos@cantinart.hu</author>

  <!-- admin -->

  <file name="admin/view/template/setting/setting.tpl">
      <operation>
              <search position="replace"><![CDATA[<?php echo $tab_server; ?>]]></search>
                                    <add><![CDATA[<?php echo $tab_server; ?></a><a href="#tab-livesearch">Live Search</a>]]></add>
      </operation>
      <operation>
              <search position="replace"><![CDATA[
			</form>
              ]]></search>
              <add><![CDATA[
	        <div id="tab-livesearch">
	          <table class="form">
	              <tr>
	                <td>Limit results:</td>
	                <td><input type="text" name="ls_limit_results" value="<?php echo $ls_limit_results; ?>" /></td>
	              </tr>
	              <tr>
	                <td>Text for link to more results:</td>
	                <td><input type="text" name="ls_more" value="<?php echo $ls_more; ?>" /></td>
	              </tr>
	              <tr>
	                <td>Display images:</td>
	                <td>
						<?php
							if ($ls_images==1) {
								?>
									<input type="radio" name="ls_images" value="1" checked="checked" /> Yes
									<input type="radio" name="ls_images" value="0" /> No
								<?php
							} else {
								?>
									<input type="radio" name="ls_images" value="1" /> Yes
									<input type="radio" name="ls_images" value="0" checked="checked" /> No
								<?php
							}
						?>
					</td>
	              </tr>
	              <tr>
	                <td>Display prices:</td>
	                <td>
						<?php
							if ($ls_prices==1) {
								?>
									<input type="radio" name="ls_prices" value="1" checked="checked" /> Yes
									<input type="radio" name="ls_prices" value="0" /> No
								<?php
							} else {
								?>
									<input type="radio" name="ls_prices" value="1" /> Yes
									<input type="radio" name="ls_prices" value="0" checked="checked" /> No
								<?php
							}
						?>
					</td>
	              </tr>
	              <tr>
	                <td>Display model:</td>
	                <td>
						<?php
							if ($ls_model==1) {
								?>
									<input type="radio" name="ls_model" value="1" checked="checked" /> Yes
									<input type="radio" name="ls_model" value="0" /> No
								<?php
							} else {
								?>
									<input type="radio" name="ls_model" value="1" /> Yes
									<input type="radio" name="ls_model" value="0" checked="checked" /> No
								<?php
							}
						?>
					</td>
	              </tr>
	              <tr>
	                <td>Search in description:</td>
	                <td>
						<?php
							if ($ls_searchindesc==1) {
								?>
									<input type="radio" name="ls_searchindesc" value="1" checked="checked" /> Yes
									<input type="radio" name="ls_searchindesc" value="0" /> No
								<?php
							} else {
								?>
									<input type="radio" name="ls_searchindesc" value="1" /> Yes
									<input type="radio" name="ls_searchindesc" value="0" checked="checked" /> No
								<?php
							}
						?>
					</td>
	              </tr>
	              <tr>
	                <td>Text for no results:</td>
	                <td><input type="text" name="ls_noresults" value="<?php echo $ls_noresults; ?>" /></td>
	              </tr>
	          </table>
	        </div>
	      </form>
              ]]></add>
      </operation>
  </file>

  <file name="admin/controller/setting/setting.php">
          <operation>
                  <search position="replace"><![CDATA[
				$this->template = 'setting/setting.tpl';
                  ]]></search>
                  <add><![CDATA[

				if (isset($this->request->post['ls_limit_results'])) {
					$this->data['ls_limit_results'] = $this->request->post['ls_limit_results']; 
				} else {
					$this->data['ls_limit_results'] = $this->config->get('ls_limit_results');
				}

				if (isset($this->request->post['ls_more'])) {
					$this->data['ls_more'] = $this->request->post['ls_more']; 
				} else {
					$this->data['ls_more'] = $this->config->get('ls_more');
				}

				if (isset($this->request->post['ls_images'])) {
					$this->data['ls_images'] = $this->request->post['ls_images']; 
				} else {
					$this->data['ls_images'] = $this->config->get('ls_images');
				}

				if (isset($this->request->post['ls_prices'])) {
					$this->data['ls_prices'] = $this->request->post['ls_prices']; 
				} else {
					$this->data['ls_prices'] = $this->config->get('ls_prices');
				}

				if (isset($this->request->post['ls_noresults'])) {
					$this->data['ls_noresults'] = $this->request->post['ls_noresults']; 
				} else {
					$this->data['ls_noresults'] = $this->config->get('ls_noresults');
				}

				if (isset($this->request->post['ls_searchindesc'])) {
					$this->data['ls_searchindesc'] = $this->request->post['ls_searchindesc']; 
				} else {
					$this->data['ls_searchindesc'] = $this->config->get('ls_searchindesc');
				}

				if (isset($this->request->post['ls_model'])) {
					$this->data['ls_model'] = $this->request->post['ls_model']; 
				} else {
					$this->data['ls_model'] = $this->config->get('ls_model');
				}

				$this->template = 'setting/setting.tpl';
                  ]]></add>
          </operation>
  </file>

  <!-- catalog -->

  <file name="catalog/controller/product/search.php">
          <operation>
                  <search position="replace" offset="1"><![CDATA[
				$this->response->setOutput($this->render());
                  ]]></search>
                  <add><![CDATA[
				$this->response->setOutput($this->render());}
				function livesearch() { 

				$this->load->model('setting/setting');
				$promo_settings = $this->model_setting_setting->getSetting('promo_settings');
				
				$promo_settings['total_discount_products'] = str_replace(" ", "", $promo_settings['total_discount_products']);
                $total_discount_products = array_diff(explode("\r\n", $promo_settings['total_discount_products']), array(''));
			
					$search = $this->request->get['search'];
					$this->load->model('catalog/product');
					$this->load->model('tool/image');
					$this->load->model('setting/setting');

					$limit = $this->config->get('ls_limit_results');
					$more = $this->config->get('ls_more');
					if ($more=="") $more = "...";
					$noresults = $this->config->get('ls_noresults');
					if ($noresults=="") $noresults = "No results";
					$images = $this->config->get('ls_images');
					$prices = $this->config->get('ls_prices');
					$model  = $this->config->get('ls_model');
					$searchindesc = ( $this->config->get('ls_searchindesc') ) ? 1 : 0;

					$data = array(
						'filter_name'        => $search,
						'filter_description' => $searchindesc,
						'start'              => 0,
						'limit'              => $limit
					);

					$products = $this->model_catalog_product->getProducts($data);
					$i = 0;
					foreach ($products as $product) {

						$results[$i]["class"] = "";
						$results[$i]["name"] = $product["name"];

						if ($model) {
							$results["$i"]["model"] = $product["model"];
						}

						$results[$i]["img"] = "";
						if ($product['image'] && $images==1) {
							$results[$i]["img"] = $this->model_tool_image->resize(
								$product['image'],
								//$this->config->get('config_image_product_width'),
								$this->config->get('config_image_additional_width'),
								//$this->config->get('config_image_product_height')
								$this->config->get('config_image_additional_height')
							);
						}

								
				
				
				
				
						if ($prices) {
							$results[$i]["price"] = $this->currency->format( $this->tax->calculate( $product['price'], $product['tax_class_id'], $this->config->get('config_tax') ) );
							if ($product['special']) {
								$results[$i]["price"] = '<strike>' . $results[$i]["price"] . '</strike> ' . $this->currency->format( $this->tax->calculate( $product['special'], $product['tax_class_id'], $this->config->get('config_tax') ) );
							}
							
							if (($promo_settings['total_discount_status'] && $this->customer->getCustomerGroupId() != 3) || ($this->customer->getId() == $promo_settings['total_discount_test_user'] && $this->customer->getId() != "")) {
                    if (!empty($total_discount_products)) {
                        if (in_array($product['product_id'], $total_discount_products)) {
                    $results[$i]["price"] = '<strike>' . $results[$i]["price"] . '</strike> ' . $this->currency->format(round(($product['price'] - $product['price']/100*$promo_settings['total_discount_conditions'])/10)*10);
                        }
                    } else{
                        $results[$i]["price"] = '<strike>' . $results[$i]["price"] . '</strike> ' . $this->currency->format(round(($product['price'] - $product['price']/100*$promo_settings['total_discount_conditions'])/10)*10);
                    }
                }
						}
						
						$results[$i]["href"] = $this->url->link('product/product', 'product_id=' . $product['product_id']);
						$i++;
					}
					if (!isset($results)) {
						$results = array();
						$results[] = array(
							"class" => ' class="amore" ',
							"img"  => "",
							"name" => '<p class="pmore">' . $noresults . '</p>',
							"href" => '#'
						);
					} else {
						if (count($results) >= $limit) {
							$results[] = array(
								"class" => " class='amore' ",
								"img"  => "",
								"name" => '<p class="pmore">'.htmlentities($more, ENT_QUOTES, 'UTF-8').'</p>',
								"href" => $this->url->link('product/search', 'description=' . $searchindesc . '&search=' . $search)
							);
						}
					}
					echo json_encode($results);
				}
                  ]]></add>
          </operation>
  </file>

  <file name="catalog/view/theme/*/template/common/header.tpl">
    <operation>
			<search position="before"><![CDATA[<?php foreach ($styles as $style) { ?>]]></search>
			                     <add><![CDATA[<link rel="stylesheet" type="text/css" href="catalog/view/javascript/livesearch/livesearch.min.css" />]]></add>
		</operation>
    <operation>
			<search position="before"><![CDATA[<?php foreach ($scripts as $script) { ?>]]></search>
			                     <add><![CDATA[<script type="text/javascript" src="catalog/view/javascript/livesearch/livesearch.min.js"></script>]]></add>
		</operation>
  </file>

</modification>